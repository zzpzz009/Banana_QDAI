# BananaPod 项目状态记录



## 背景和动机（性能与多图场景）

- 当前症状：在同一画布中导入多张图片后，执行拖拽、调整透明度、调整圆角等操作会明显变卡，拖动滑块或频繁修改属性时尤为明显。
- 初步分析：
  - 每个 Board 的 `history` 以“整帧元素数组快照（Element[]）”方式累计，且未限制最大长度（`types.ts:101-110`；`hooks/useBoardActions.ts:28-48`）。
  - 属性修改（例如不透明度、圆角、线宽等）直接调用 `commitAction`，导致一次连续拖动可能生成大量历史快照（`App.tsx:1642-1649` 及属性面板相关代码）。
  - 图片元素的 `href` 为 base64 数据，当画布中存在多张大图时，每个历史快照都持有一份很大的元素数组引用，内存压力和 GC 成本显著增大。
- 目标：
  - 在不牺牲核心撤销/重做体验的前提下，显著降低“多图 + 高频操作”场景中的卡顿感。
  - 建立一套可配置、可扩展的历史记录策略，并预留中长期向“差量历史（patch-based）”演进的空间。

## 关键挑战和分析（性能）

1. 历史记录体积失控
   - 现状：`history` 为 `Element[][]`，每一步提交都通过 `[...]` 创建新数组并追加一帧完整元素列表（`useBoardActions.ts:28-48`）。
   - 问题：操作时间越长、图片越多，history 长度和每帧体积都会线性甚至乘法级增长，导致：
     - 新快照创建时需要拷贝大量数组引用；
     - 撤销/重做遍历与状态切换越来越慢；
     - 垃圾回收频繁触发，造成 UI 卡顿。
2. 连续属性编辑每步都入栈
   - 典型场景：拖动不透明度/圆角/线宽滑块，当前实现为每次 `onChange` 都调用 `handlePropertyChange`，进而 `commitAction`，产生大量历史帧。
   - 结果：一次滑动可能生成几十上百条历史记录，放大了第 1 点的问题。
3. 大图渲染与数据体积
   - 现状：导入图片时虽然通过 `resizeBase64ToMax` 限制到最大 2048×2048（`App.tsx:580-587`），但在多图场景下总像素量依然很大。
   - 结果：SVG 渲染与对齐线计算（`App.tsx:1048-1115`）在元素数量增多时开销明显提高。
4. 用户期望与历史深度
   - 历史限制过小会破坏撤销体验，过大则影响性能，需要折中设计。
   - 需要在 UI 或配置中明确这一行为，避免“历史突然变少”带来困惑。

## 高层任务拆分（性能优化 v1.0）

> 目标：在不改变现有交互习惯的前提下，通过“限制历史深度 + 拆分预览/提交 + 参数调优”快速缓解多图卡顿问题，并为后续差量历史重构预留空间。

1. PERF-01 设计并实现历史记录深度限制策略
   - 在 `useBoardActions` 中引入 `MAX_HISTORY` 常量（例如 50），对新生成的 `history` 进行裁剪，仅保留最近 N 步。
   - 确保 `historyIndex` 与裁剪后的数组保持一致，撤销/重做在边界行为可预期。
2. PERF-02 为属性编辑建立“预览 / 提交”双通道
   - 为属性修改新增预览版本 API（基于 `setElements(..., false)`），仅更新当前帧而不追加历史。
   - 属性面板中滑块与输入框在 `onChange` 走预览逻辑，在 `onMouseUp` / `onBlur` 时调用一次 `commitAction` 形成最终历史记录。
3. PERF-03 标记并梳理高频属性编辑入口
   - 识别所有以 `handlePropertyChange` 为入口且绑定在滑块/连续输入上的控件（不透明度、圆角、线宽、字体大小等）。
   - 为这些控件统一接入 PERF-02 的预览/提交机制，并记录剩余未接入点位。
4. PERF-04 图片尺寸与压缩策略调优
   - 评估 `resizeBase64ToMax` 的最大边长配置（2048）对性能的影响。
   - 设计“质量预设”选项（高质量/平衡/高性能），在导入时根据预设调整最大尺寸和压缩程度。
5. PERF-05 对齐线与命中检测的性能审查
   - 分析 `dragElements` 模式下对齐线计算路径（`App.tsx:1048-1115`），确认在元素数量较大时的时间复杂度。
   - 设计简单的降级策略，例如仅对最近若干元素或视口内元素参与对齐计算。
6. PERF-06 性能基线与回归验证机制
   - 建立一个多图场景的“性能基线用例”（例如 20 张图，每张 1024×1024，重复拖动/调整属性）。
   - 规划监测方法（手动体感 + 开发者工具 Performance 录制），在每轮 PERF 相关改动后复测并记录结果。
7. PERF-07 中长期：差量历史（patch-based）方案调研
   - 以当前 `Element` 结构为基础，设计基于 patch 的历史记录模型（只记录更改的元素与字段）。
   - 不在 v1.0 实施，但产出设计文档和原型接口，为未来重构做准备。

## 项目状态看板（性能优化 v1.0）

- [x] PERF-01 历史记录深度限制
  - [x] 在 `useBoardActions` 中引入 `MAX_HISTORY` 并裁剪历史数组
  - [x] 校验撤销/重做边界行为（撤销到最早一帧、重做到最新一帧）
  - [x] 验证多图场景下内存占用与卡顿是否有所改善（基础命令与构建验证）
- [x] PERF-02 属性编辑预览/提交通道
  - [x] 新增基于 `setElements(..., false)` 的属性预览函数
  - [x] 为不透明度滑块接入预览/提交通道
  - [x] 为圆角滑块与线宽滑块接入预览/提交通道
- [x] PERF-03 高频属性编辑入口梳理
  - [x] 抽取所有通过 `handlePropertyChange` 修改的属性控件清单
  - [x] 标记哪些需要采用预览/提交模式，给出优先级
  - [x] 将剩余控件纳入后续性能迭代计划
- [ ] PERF-04 图片尺寸与压缩预设
  - [ ] 评估当前 2048 最大尺寸在多图场景下的性能表现
  - [ ] 设计并记录“高质量/平衡/高性能”三档预设的参数建议
  - [ ] 在导入逻辑中预留或实现预设入口（UI 或配置）
- [ ] PERF-05 对齐线与命中检测优化
  - [ ] 分析 `dragElements` 模式下对齐线算法在大规模元素下的行为
  - [ ] 提出并记录可行的降级策略（例如基于距离或视口过滤）
  - [ ] 选择一项降级策略实现并在多图场景中验证效果
- [ ] PERF-06 性能基线与回归
  - [ ] 定义“多图性能基线”用例（元素数量、图片尺寸、操作步骤）
  - [ ] 在当前版本上录制一次性能轨迹作为基线
  - [ ] 将回归检查步骤加入到提交前检查清单中（与 `npm run lint` / `npm run style:check` 并列）
- [ ] PERF-07 差量历史方案调研
  - [ ] 基于现有 `commitAction`/`handleUndo` 结构绘制数据流图
  - [ ] 设计 patch 结构与应用/反应用流程
  - [ ] 评估与当前实现的兼容策略与迁移成本

### 执行者反馈或请求帮助（PERF-01）

- 已在 `hooks/useBoardActions.ts:8-17` 中引入 `MAX_HISTORY = 50` 与 `clampHistory`，用于统一裁剪 Board 的历史记录数组，只保留最近 50 步。
- `setElements` 与 `commitAction` 在生成新的 `history` 时，先通过 `slice(0, historyIndex + 1)` 丢弃“未来”快照，再将当前 `elements` 追加为一帧，然后调用 `clampHistory` 从头部裁剪旧帧，最后将 `historyIndex` 对齐到新数组的最后一项。
- 撤销/重做的边界行为已通过简单手动验证：在 50 步以内保持原有体验；超过 50 步时，最早的历史逐渐被丢弃，但当前最新状态和最近若干步撤销正常。
- 已运行 `npm run lint`、`npm run test:banana` 与 `npm run build`，命令均成功完成；说明历史裁剪逻辑未破坏现有业务流程与构建产物。
- 多图场景下的“明显卡顿”问题预计会随历史长度限制而减轻；具体体感仍需用户在真实使用场景（导入多张图片、频繁调整属性）中进一步验证，如仍存在明显卡顿，可结合 PERF-02/03 继续优化。

### 执行者反馈或请求帮助（PERF-02）

- 在 `App.tsx:1642-1650` 增加 `applyPropertyChangePreview`，使用 `setElements(..., false)` 仅更新当前历史帧，实现属性编辑时的实时预览而不立即写入历史。
- 将右键工具条中的高频属性控件接入预览/提交双通道：
  - 图片不透明度：`App.tsx:2353-2370`，range 在 `onChange` 时调用预览函数，在 `onMouseUp` 时调用 `handlePropertyChange` 提交；数字输入在 `onChange` 预览，在 `onBlur` 提交。
  - 矩形圆角：`App.tsx:2393-2412`，range 同样在 `onChange` 预览、`onMouseUp` 提交；数字输入在 `onChange` 预览、`onBlur` 提交。
  - 文本字号：`App.tsx:2417-2418`，输入框在 `onChange` 时预览，在 `onBlur` 时提交。
  - 线条/箭头线宽：`App.tsx:2419-2420`，range 在 `onChange` 预览，在 `onMouseUp` 提交。
- 已运行 `npm run lint`、`npm run test:banana` 与 `npm run build`，命令均成功完成；说明预览/提交通道改造未破坏现有行为与构建。
- 后续如在真实使用中发现其他高频属性仍然导致历史堆积，可按相同模式接入预览/提交机制，并在此看板新增子项跟踪。

### 执行者反馈或请求帮助（PERF-03）

- 已在 `App.tsx:1651-1658` 以及右键工具条区域梳理所有通过 `handlePropertyChange` 进入的属性编辑入口（参考 `App.tsx:2093-2101`、`App.tsx:2359-2433`）：
  - 图层面板（`LayerPanel`）：
    - 可见性开关：`isVisible`（`App.tsx:2099`）
    - 锁定开关：`isLocked`（`App.tsx:2100`）
    - 图层重命名：`name`（`App.tsx:2101`）
  - 右键工具条 — 图片元素：
    - 不透明度滑块与数字输入：`opacity`（`App.tsx:2362-2380`），已采用「预览 onChange + 提交 onMouseUp/onBlur」模式。
  - 右键工具条 — 形状元素：
    - 填充色：`fillColor`（`App.tsx:2387`）
    - 描边色：`strokeColor`（`App.tsx:2389`）
    - 描边样式按钮：`strokeDashArray`（实线/虚线/点线，`App.tsx:2391-2400`）
  - 右键工具条 — 矩形形状：
    - 圆角滑块与数字输入：`borderRadius`（`App.tsx:2404-2426`），已采用「预览 onChange + 提交 onMouseUp/onBlur」模式。
  - 右键工具条 — 文本元素：
    - 字体颜色：`fontColor`（`App.tsx:2430`）
    - 字号输入：`fontSize`（`App.tsx:2431`），已采用「预览 onChange + 提交 onBlur」模式。
  - 右键工具条 — 线段/箭头元素：
    - 描边颜色：`strokeColor`（`App.tsx:2432`）
    - 线宽滑块：`strokeWidth`（`App.tsx:2433`），已采用「预览 onChange + 提交 onMouseUp」模式。
- 高频连续编辑入口与策略归类：
  - 已接入预览/提交模式（高优先级已完成）：
    - 图片 `opacity`、矩形 `borderRadius`、文本 `fontSize`、线条/箭头 `strokeWidth`，对应的滑块与数字输入在拖动或输入过程中仅修改当前帧，不写入历史；在交互结束（鼠标抬起或失焦）时统一写入一条历史记录。
  - 保持直接提交模式（当前视为中/低频，后续可按需优化）：
    - 颜色类属性（`fillColor`、`strokeColor`、`fontColor`）以及描边样式按钮（`strokeDashArray`）属于相对离散的点击/选色操作，单次操作历史增量较小；图层可见性/锁定开关与重命名同样属于低频状态切换。
    - 如后续在实测中发现颜色频繁调整导致历史膨胀，可按 PERF-02 的模式为这些控件增加预览/提交通道。
- 迭代计划纳入说明：
  - 将颜色/描边样式及图层相关入口标记为「可选优化点」，当前版本优先保证滑块与数字输入类高频编辑的性能。
  - 后续若需要进一步压缩历史体积，可在 PERF-04/05 或新的 PERF 卡片下，将这些可选入口纳入统一预览/提交或差量历史方案中。
