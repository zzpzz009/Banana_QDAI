# BananaSidebar｜香蕉按钮展开界面复制交互与场景卡片逻辑重构计划（规划者）

## 背景和动机

- 当前香蕉按钮展开后的底部面板包含三块核心区域：
  - 上方嵌入的 LeaderAI 提示词网页 iframe（网页区域）
  - 下方的场景卡片区域（预设提示词）
  - 新增的“已接收的提示词”侧边区域（手动复制辅助）
- 由于非 HTTPS 部署导致内嵌网页自身的剪贴板复制受限，需要在宿主侧设计一套“复制 → 手动粘贴”的稳定流程。
- 用户希望这三个区域之间的显示/隐藏逻辑更加清晰、可控，最终目标是同时满足以下 6 条行为规范：
  1. 点击香蕉按钮默认打开状态为「网页 + 场景卡片」，不出现侧边区域。
  2. 只有在网页区域有鼠标点击动作时才隐藏场景卡片，鼠标悬停不隐藏。
  3. 侧边区域只在点击网页中复制按钮时才会出现，默认为隐藏状态。
  4. 侧边区域出现时，若场景卡片为显示状态则自动隐藏场景卡片。
  5. 手动调出场景卡片时，侧边区域和场景卡片共存，此时鼠标点击网页区域依旧可以自动隐藏场景卡片。
  6. 侧边区域手动隐藏后，需要再次点击网页中复制按钮时才会出现。
- 本计划以规划者身份输出，将上述 6 条需求拆解为清晰的实现任务与状态看板，供执行者逐条落地并回填进度。


## 关键挑战和分析

1. iframe 跨域限制
   - 宿主页面无法直接监听 iframe 内部的所有鼠标事件，只能依赖来自 iframe 的 `postMessage`。
   - “网页区域有鼠标点击动作”的可观测信号，实际上只能通过约定好的消息（例如复制按钮点击时发送）实现。
2. 状态之间的相互影响较多
   - 至少包含以下状态：
     - `isOpen`：香蕉面板是否展开
     - `cardsCollapsed`：场景卡片是否折叠（用户手动控制）
     - `showLabPanel`：侧边“已接收的提示词”区域是否显示
     - `lastLabPrompt`：侧边区域中展示的提示词内容
     - `autoHideCards`：场景卡片当前是否处于“被复制事件自动隐藏”的状态
   - 需要清晰区分“用户显式操作”和“复制事件带来的自动行为”，避免状态打架或出现意外重置。
3. 默认体验与特例体验的平衡
   - 默认打开时，应始终是“网页 + 场景卡片”，让新用户快速理解功能。
   - 只有在用户开始使用网页里的“复制”能力后，才引入侧边区域和自动隐藏卡片的逻辑。
4. 手动恢复的优先级
   - 当用户主动“调出场景卡片”时，应该认为用户显式覆盖了之前的自动隐藏决策，同时允许卡片和侧边并存。
   - 之后再次从网页复制时，仍需要具备“可以自动隐藏卡片”的能力，避免逻辑陷入不可恢复状态。
5. 清空与重置策略
   - 隐藏侧边区域时，需要决定是否保留 `lastLabPrompt`：
     - 若保留，将导致下次侧边区域出现时带着旧内容，可能造成困惑。
     - 若清空，则每次出现都是“最新一次复制”的内容，更符合直觉。
   - 同时要注意不要意外清空 PromptBar 中的输入内容，避免用户编辑中的提示词丢失。


## 高层任务拆分（按 6 条行为规范拆解）

> 目标：在 `components/BananaSidebar.tsx` 中，通过精细管理状态与事件来源，严格实现 6 条交互逻辑；并为执行者提供清晰的单步任务与完成标准。

### 任务组 A：默认展开状态与基础布局

**A1. 默认展开状态保持为「网页 + 场景卡片」**
- 任务内容：
  - 确认并保证香蕉按钮首次点击展开时：
    - iframe 网页区域始终显示。
    - 场景卡片区域在 `cardsCollapsed === false` 时显示。
    - 侧边“已接收的提示词”区域默认不显示。
  - 验证 `showLabPanel` 和 `lastLabPrompt` 的初始值为隐藏 / 空字符串。
- 成功标准：
  - 刷新页面后首次展开香蕉面板，视觉上只有「网页 + 场景卡片」，侧边区域不出现。

**A2. 保持现有布局高度与缩放策略不变**
- 任务内容：
  - 在重构交互逻辑时，不改动 iframe 容器高度、缩放比例以及卡片区域的高度设定。
  - 确保本次调整只作用于显示/隐藏逻辑，不影响整体视觉布局。
- 成功标准：
  - 执行完成后，与现有版本相比，在相同窗口尺寸下面板高度无明显跳变。


### 任务组 B：网页点击与场景卡片隐藏逻辑

**B1. 定义“网页区域有鼠标点击动作”的可观测信号**
- 任务内容：
  - 将“网页区域内点击复制按钮，并通过 `postMessage` 发送消息”的事件视为“网页有点击动作”的代理信号。
  - 在 BananaSidebar 中统一入口为 `window.addEventListener('message', handler)` 中的处理逻辑。
- 成功标准：
  - 代码中不尝试直接监听 iframe 内部的 DOM 事件，而是明确只依赖 `postMessage`。

**B2. 在网页复制事件发生时自动隐藏场景卡片**
- 任务内容：
  - 在 `handler` 中接收到有效 `prompt` 文本并写入 `setPrompt` / `setLastLabPrompt` 后：
    - 将 `autoHideCards` 设置为 `true`，表示“当前由复制事件驱动的隐藏状态”。
  - 在渲染场景卡片时使用条件 `!cardsCollapsed && !autoHideCards`。
- 成功标准：
  - 当页面处于“网页 + 场景卡片”状态时，从网页点击复制按钮后：
    - 场景卡片自动隐藏。
    - 侧边区域（若需求要求）根据后续任务出现。
  - 鼠标仅悬停在 iframe 上，不会影响卡片显示状态。


### 任务组 C：侧边“已接收的提示词”区域的出现/隐藏

**C1. 侧边区域只在复制事件发生时出现**
- 任务内容：
  - 在 `handler` 中，当提取到非空 `trimmed` 提示词时：
    - 调用 `setShowLabPanel(true)`。
    - 更新 `setLastLabPrompt(trimmed)`。
  - 不在其他任何地方主动将 `showLabPanel` 置为 `true`。
- 成功标准：
  - 手动打开/关闭香蕉面板、切换卡片折叠状态等操作不会触发侧边区域出现。
  - 只有点击网页中的复制按钮（即触发 `postMessage` 携带提示词）时，才会看到侧边区域第一次出现。

**C2. 侧边区域出现时自动隐藏场景卡片（若当前显示）**
- 任务内容：
  - 在 C1 的同一处理逻辑中同时设置 `setAutoHideCards(true)`。
  - 利用 B2 的渲染条件自动隐藏卡片。
- 成功标准：
  - 当场景卡片原本为显示状态时，侧边区域第一次出现的瞬间，卡片被自动隐藏。
  - 若卡片本来就是折叠状态，则不会改变用户的折叠选择。

**C3. 手动隐藏侧边区域时清空内容并恢复默认状态**
- 任务内容：
  - 为“隐藏”按钮绑定 `handleHideLabPanel`，实现以下逻辑：
    - `setShowLabPanel(false)`：关闭侧边区域。
    - `setLastLabPrompt('')`：清空侧边区域的提示词内容。
    - `setAutoHideCards(false)`：退出自动隐藏模式，卡片只受 `cardsCollapsed` 控制。
  - 不修改 PromptBar 中的主输入内容，避免用户编辑中的提示被清空。
- 成功标准：
  - 隐藏侧边区域后，重新展开香蕉面板时不会残留旧提示词内容。
  - 在隐藏侧边区域后，场景卡片的可见性完全由用户的折叠状态决定。


### 任务组 D：手动调出场景卡片与共存逻辑

**D1. 设计“自动隐藏卡片”的可恢复机制**
- 任务内容：
  - 在折叠/展开场景卡片的控制按钮中，不直接操作 `cardsCollapsed`，而是通过 `handleToggleCards` 统一处理：
    - 若当前处于 `autoHideCards === true`：
      - 先执行 `setAutoHideCards(false)`，表示用户显式打破自动隐藏。
      - 然后执行 `setCardsCollapsed(false)`，强制展开卡片。
    - 若当前 `autoHideCards === false`：
      - 简单 `setCardsCollapsed(prev => !prev)` 即可。
- 成功标准：
  - 当侧边区域出现且卡片被自动隐藏时，用户点击一次折叠按钮，即可将卡片显示出来，并解除自动隐藏状态。

**D2. 保证侧边区域与场景卡片可以共存**
- 任务内容：
  - 在渲染场景卡片时使用 `!cardsCollapsed && !autoHideCards`。
  - 在 D1 中，当用户显式取消自动隐藏时，不改变 `showLabPanel`，保持侧边区域继续显示。
- 成功标准：
  - 在侧边区域已经显示的状态下，用户通过折叠按钮可以让卡片再次显示，两者同时存在。

**D3. 在共存状态下保留“再次点击网页可自动隐藏卡片”的能力**
- 任务内容：
  - 在后续的复制事件处理逻辑中（同 C1 / B2）继续设置：
    - `setAutoHideCards(true)`。
  - 不因 D1 的手动恢复而永久禁止自动隐藏。
- 成功标准：
  - 在“侧边区域 + 场景卡片共存”的状态下，再次从网页点击复制按钮：
    - 侧边区域仍然存在或更新内容。
    - 场景卡片再次被自动隐藏。


### 任务组 E：侧边区域再次出现的触发条件

**E1. 侧边区域手动隐藏后不再自动出现**
- 任务内容：
  - 确认所有位置只在复制事件中调用 `setShowLabPanel(true)`。
  - 手动隐藏侧边区域时，不设置任何延迟或其他路径导致它重新出现。
- 成功标准：
  - 用户关闭侧边区域后，仅仅打开/关闭香蕉面板或切换卡片折叠状态不会让侧边区域复活。

**E2. 再次点击网页中复制按钮时侧边区域重新出现**
- 任务内容：
  - 在复制事件中，无条件调用 `setShowLabPanel(true)` 和 `setLastLabPrompt(trimmed)`。
  - 不依赖历史的 `showLabPanel` / `lastLabPrompt` 状态。
- 成功标准：
  - 手动隐藏侧边区域后，用户再次在网页中点击复制：
    - 侧边区域重新出现。
    - 显示的内容为“本次复制”的最新提示词。


## 项目状态看板（香蕉按钮展开界面 6 条逻辑）

- [ ] A1 默认展开状态保持为「网页 + 场景卡片」
- [ ] A2 保持布局高度与缩放策略不变
- [ ] B1 使用复制事件作为“网页点击”的代理信号
- [ ] B2 在复制事件发生时自动隐藏场景卡片
- [ ] C1 侧边区域只在复制事件发生时出现
- [ ] C2 侧边区域出现时自动隐藏场景卡片（若当前显示）
- [ ] C3 手动隐藏侧边区域时清空内容并退出自动隐藏模式
- [ ] D1 通过 handleToggleCards 实现自动隐藏的可恢复机制
- [ ] D2 保证侧边区域与场景卡片可以共存
- [ ] D3 共存状态下再次复制仍可自动隐藏卡片
- [ ] E1 手动隐藏侧边区域后不再自动出现
- [ ] E2 再次点击复制按钮时侧边区域重新出现并展示最新内容


## 执行者反馈或请求帮助（待执行）

- 执行者在开始实现任一任务前，应：
  - 从“项目状态看板”中选择一个未完成项，将其标记为进行中（在本文件中更新）。
  - 在实现前先阅读 `components/BananaSidebar.tsx` 相关状态定义与现有逻辑，避免重复实现或引入回归。
- 执行完单个任务后，应：
  - 在本文件对应任务项勾选完成，并简要记录：
    - 涉及的文件与行号（例如：`components/BananaSidebar.tsx:166-247`）。
    - 简要的行为验证步骤（例如：在什么操作序列下验证通过）。
  - 至少做一次 `npm run lint` 或项目既有的检查命令，确认没有新警告或错误。
- 如在实现过程中发现：
  - LeaderAI 网页未能稳定发送 `postMessage`，或消息结构与预期不同；
  - 现有状态变量难以满足 6 条逻辑的需要；
  - 需要新增配置项或翻译文案；
  应在本节追加“问题描述 + 建议调整方案”，由规划者复盘后再迭代任务清单。
